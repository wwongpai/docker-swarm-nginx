# Load the Datadog nginx tracing module (APM)
load_module /usr/lib/nginx/modules/ngx_http_datadog_module.so;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # ── Datadog APM ──────────────────────────────────────────────────────────
    datadog_agent_url  http://datadog-agent:8126;
    datadog_service_name nginx-gateway;
    datadog_environment demo;
    datadog_version     1.0.0;
    datadog_sample_rate 1.0;

    # Propagate W3C trace-context + Datadog headers to upstream apps
    datadog_propagation_styles tracecontext datadog;

    # ── JSON access log (includes DD trace/span IDs for log correlation) ─────
    log_format dd_json escape=json
        '{'
            '"timestamp":"$time_iso8601",'
            '"remote_addr":"$remote_addr",'
            '"method":"$request_method",'
            '"uri":"$request_uri",'
            '"status":$status,'
            '"body_bytes_sent":$body_bytes_sent,'
            '"request_time":$request_time,'
            '"upstream_addr":"$upstream_addr",'
            '"upstream_status":"$upstream_status",'
            '"upstream_response_time":"$upstream_response_time",'
            '"http_user_agent":"$http_user_agent",'
            '"dd.trace_id":"$datadog_trace_id",'
            '"dd.span_id":"$datadog_span_id"'
        '}';

    access_log /dev/stdout dd_json;
    error_log  /dev/stderr warn;

    sendfile on;
    keepalive_timeout 65;

    server {
        listen 80;
        server_name _;

        # ── Route /java/* → Spring Boot app ──────────────────────────────────
        location /java/ {
            proxy_pass         http://springboot-app:8080/;
            proxy_set_header   Host              $host;
            proxy_set_header   X-Real-IP         $remote_addr;
            proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
            datadog_resource_name "$request_method /java/";
        }

        # ── Route /php/* → Laravel app ────────────────────────────────────────
        location /php/ {
            proxy_pass         http://laravel-app:80/;
            proxy_set_header   Host              $host;
            proxy_set_header   X-Real-IP         $remote_addr;
            proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
            datadog_resource_name "$request_method /php/";
        }

        # ── nginx stub_status for Datadog nginx metrics integration ───────────
        location /nginx_status {
            stub_status;
            datadog_tracing off;   # don't trace internal scrape requests
            allow 127.0.0.1;
            allow 10.0.0.0/8;   # Docker overlay network CIDR
            deny  all;
        }

        # ── Health probe ──────────────────────────────────────────────────────
        location /health {
            datadog_tracing off;
            return 200 "ok\n";
            add_header Content-Type text/plain;
        }
    }
}
